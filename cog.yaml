build:
  gpu: true
  cuda: "12.1"
  system_packages:
    - ffmpeg
    - git
    - jq
  python_version: "3.10.6"
  python_packages:
    - torch
    - torchvision
    - torchaudio
    - torchsde
    - einops
    - transformers>=4.28.1
    - tokenizers>=0.13.3
    - sentencepiece
    - safetensors>=0.3.0
    - aiohttp
    - accelerate
    - pyyaml
    - Pillow
    - scipy
    - tqdm
    - psutil
    - spandrel
    - soundfile
    - kornia>=0.7.1
    - websocket-client==1.6.3
    - diffusers>=0.30.0

    # fix for pydantic issues in cog
    # https://github.com/replicate/cog/issues/1623
    - albumentations==1.4.3

    # was-node-suite-comfyui
    # https://github.com/WASasquatch/was-node-suite-comfyui/blob/main/requirements.txt
    - cmake
    - imageio
    - joblib
    - matplotlib
    - pilgram
    - scikit-learn
    - rembg

    # ComfyUI_essentials
    - numba

    # ComfyUI-Impact-Pack
    - segment-anything
    - piexif

    # For train.py
    - huggingface_hub
  run:
    - apt-get update && apt-get install -y gnupg2
    - apt-key adv --keyserver keyserver.ubuntu.com --recv-keys A4B469963BF863CC
    - apt-get update && apt-get install -y curl
    - curl -o /usr/local/bin/pget -L "https://github.com/replicate/pget/releases/download/v0.8.1/pget_linux_x86_64" && chmod +x /usr/local/bin/pget
    - pip install onnxruntime-gpu --extra-index-url https://aiinfra.pkgs.visualstudio.com/PublicPackages/_packaging/onnxruntime-cuda-12/pypi/simple/
    - mkdir -p /comfyui/custom_nodes/
    - jq -r '.[] | "mkdir -p /comfyui/custom_nodes/" + (.repo | split("/")[-1] | sub(".git$"; "")) + " && git clone " + .repo + " /comfyui/custom_nodes/" + (.repo | split("/")[-1] | sub(".git$"; "")) + " && cd /comfyui/custom_nodes/" + (.repo | split("/")[-1] | sub(".git$"; "")) + " && git checkout " + .commit' custom_nodes.json | sh
    - find /comfyui/custom_nodes/ -type f -name install.py -exec python3 {} \;
    - export JUGGERNAUT_XL_URL="https://civitai.com/models/133005?modelVersionId=348913"
    - export ADD_DETAIL_XL_URL="https://huggingface.co/madebyollin/sdxl-vae-fp16-fix/resolve/main/sdxl_vae.safetensors"
    - export ARS_MJ_STYLE_XL_URL="https://civitai.com/api/download/models/636076?type=Model&format=SafeTensor"
    - export FRESH_IDEAS_PIXAR_URL="https://civitai.com/api/download/models/599318?type=Model&format=SafeTensor"
    - export POP_ART_STYLE_URL="https://civitai.com/api/download/models/192584?type=Model&format=SafeTensor"
    - export SD_XL_BASE_URL="https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0/resolve/main/sd_xl_base_1.0.safetensors"
    - export SDXL_VAE_URL="https://huggingface.co/stabilityai/sdxl-vae/resolve/main/sdxl_vae.safetensors"
    - export IP_ADAPTER_SDXL_URL="https://huggingface.co/h94/IP-Adapter/resolve/main/sdxl_models/ip-adapter_sdxl.safetensors"
    - export IP_ADAPTER_IMAGE_ENCODER_URL="https://huggingface.co/h94/IP-Adapter/resolve/main/sdxl_models/image_encoder/model.safetensors"
predict: "predict.py:Predictor"
image: "r8.im/replicate/cog-comfyui:latest"
